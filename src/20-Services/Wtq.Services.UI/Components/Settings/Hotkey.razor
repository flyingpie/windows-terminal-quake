@using Wtq.Services.UI.Extensions

@inject IWtqBus Bus

@code {

	private bool _isSuper;

	[EditorRequired]
	[Parameter]
	public HotkeyOptions Options { get; set; } = new();

	[EditorRequired]
	[Parameter]
	public Action OnRemove { get; set; }

	private string Description
	{
		get
		{
			if (Options.Key != Keys.None || Options.Modifiers != KeyModifiers.None)
			{
				return Options.ToString();
			}

			return "(press a shortcut here)";
		}
	}

	private void Clear()
	{
		Options.Modifiers = KeyModifiers.None;
		Options.Key = Keys.None;
	}

	private void HandleFocusGained(FocusEventArgs e) => Bus.Publish<WtqSuspendHotkeysEvent>();

	private void HandleFocusLost(FocusEventArgs e) => Bus.Publish<WtqResumeHotkeysEvent>();

	private void HandleKeyDown(KeyboardEventArgs e)
	{
		Console.WriteLine($"CTRL:{e.CtrlKey} ALT:{e.AltKey} SHIFT:{e.ShiftKey} KB CODE:{e.Code} KEY:{e.Key} TYPE:{e.Type} LOCATION:{e.Location} IsComposing:{e.IsComposing}");

		if (e.IsSuperKey())
		{
			_isSuper = true;
		}

		e.ToModifiersAndKey(out var mod, out var key);

		if (_isSuper)
		{
			mod |= KeyModifiers.Super;
		}

		Options.Modifiers = mod;

		if (UseKeyCodes.Contains(key))
		{
			Options.Key = key;
			Options.KeyChar = null;
		}
		else
		{
			Options.Key = null;
			Options.KeyChar = e.Key;
		}
	}

	private void HandleKeyUp(KeyboardEventArgs e)
	{
		if (e.IsSuperKey())
		{
			_isSuper = false;
		}
	}

	public static HashSet<Keys> UseKeyCodes { get; } = new()
	{
		Keys.Add, Keys.Divide, Keys.Multiply, Keys.D2,
	};

}

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8">

	<!-- Shortcut capturing textbox -->
	<RadzenTextBox
		Style="width: 100%;"
		@onkeydown="HandleKeyDown"
		@onkeyup="HandleKeyUp"
		@onfocus="HandleFocusGained"
		@onblur="HandleFocusLost"
		Placeholder="Type here to set hotkey."
		Value="@Description"
	/>

	<!-- Clear button -->
	<RadzenButton
		Icon="backspace"
		Size="ButtonSize.Medium"
		Click="@(() => Clear())"
	/>

	<!-- Remove button -->
	<RadzenButton
		Icon="delete"
		Size="ButtonSize.Medium"
		Click="@(() => OnRemove())"
	/>

</RadzenStack>